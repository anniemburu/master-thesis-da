# -*- coding: utf-8 -*-
"""random_forest_exp.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1d8pEjBtVTPHBmjZpScE8bfTD9Oq-TQKm
"""

import pandas as pd
import numpy as np
import json

from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error
from sklearn.metrics import r2_score

import warnings
warnings.filterwarnings("ignore")

import os

print(f'We are at{os.getcwd()}')
target_dir = '/home/mburu/'
os.chdir(target_dir)
print(f'We are at{os.getcwd()}')

path = '/home/mburu/Master_Thesis/master-thesis-da/datasets'

output_path = '/home/mburu/Master_Thesis/master-thesis-da/experiments_results/version_1'

#datasets
folder_names = [f for f in os.listdir(path) if os.path.isdir(os.path.join(path, f))]

#variable dicts
#with open(f"{path}/variable_dict.json", "r") as json_file:
   # variable_dict = json.load(json_file)

class MultiRandomForestRegressor:
    def __init__(self, path, output_path,folder_name):
        self.path = path
        self.output_path = output_path
        self.folder_names = folder_names
        self.results_df = pd.DataFrame(columns=['Model', 'Dataset', 'Train RSME', 'Test RSME', 'Train R2', 'Test R2'])

    def data_load(self, folder):
        #load train and test datasets
        train = pd.read_csv(f'{self.path}/{folder}/train.csv')
        test = pd.read_csv(f'{self.path}/{folder}/test.csv')
        print(f'DATASETS {self.folder_names}')
        print(train.head())
        print(test.head())

        #Get X and y for train and test
        X_train, y_train = train.iloc[:, :-1], train.iloc[:, -1]
        X_test, y_test = test.iloc[:, :-1], test.iloc[:, -1]

        return X_train, y_train, X_test, y_test


    def fit(self):
        for folder in self.folder_names:
            X_train, y_train, X_test, y_test = self.data_load(folder)
           
            #train random forest
            self.model = RandomForestRegressor(random_state=0)
            self.model.fit(X_train, y_train)

            train_rmse, test_rmse, train_r2, test_r2 = self.predict(X_train, y_train, X_test, y_test)

             #Output
            results = {}
            results['rmse'] = [np.round(train_rmse,4), np.round(test_rmse,4)]
            results['r2'] = [np.round(train_r2,2), np.round(test_r2,2)]

            #add results to datasets
            new_row = {'Model': 'Random Forest', 'Dataset': folder, 'Train RSME': train_rmse, 'Test RSME': test_rmse, 'Train R2': train_r2, 'Test R2': test_r2}
            self.results_df = pd.concat([self.results_df, pd.DataFrame([new_row])], ignore_index=True)

            print(f'Results for {folder}:')
            print(pd.DataFrame(results, index=['Training', 'Testing']).T)
            print('\n')

        #save results
        self.results_df.to_csv(f'{self.path}/{folder}/xgb_v1.csv', index=False)

    def predict(self, X_train, y_train, X_test, y_test):
        train_pred = self.model.predict(X_train)
        test_pred = self.model.predict(X_test)

        #calculate RMSE
        train_rmse = np.sqrt(mean_squared_error(y_train, train_pred))
        test_rmse = np.sqrt(mean_squared_error(y_test, test_pred))

        #calculate r2
        train_r2 = r2_score(y_train, train_pred)
        test_r2 = r2_score(y_test, test_pred)

        return train_rmse, test_rmse, train_r2, test_r2

mod = MultiRandomForestRegressor(path, output_path,folder_names)
mod.fit()
